apiVersion: v1
id: excel
version: 0.1.0
vars:
  output_config:
    sheet: Results
    start_row: 2
    columns:
    - date
    - invoice_no
    - amount
    - status
  items: []
policy:
  on_error: continue
  retries: 0
  concurrency: null
  timeout_ms: null
ui:
  layout:
  - upload_evidence
  - upload_excel
  - ui_confirm
graph:
- id: upload_evidence
  block: ui.file_uploader.evidence_zip
  type: null
  max_workers: null
  priority: null
  in: {}
  out:
    evidence_zip: evidence_zip
  when: null
  foreach: null
  while: null
  body: null
  call: null
  policy: null
  hitl: null
- id: upload_excel
  block: ui.file_uploader.excel
  type: null
  max_workers: null
  priority: null
  in: {}
  out:
    workbook: workbook
  when: null
  foreach: null
  while: null
  body: null
  call: null
  policy: null
  hitl: null
- id: ui_confirm
  block: ui.confirmation
  type: null
  max_workers: null
  priority: null
  in:
    message: 請求書と入金明細の照合を開始します。続行しますか？
    options:
    - approve
    - reject
  out:
    approved: approved
    comment: comment
  when: null
  foreach: null
  while: null
  body: null
  call: null
  policy: null
  hitl: null
- id: parse_zip
  block: file.parse_zip_2tier
  type: null
  max_workers: null
  priority: null
  in:
    zip_bytes: ${upload_evidence.evidence_zip}
  out:
    evidence: evidence_data
  when:
    expr: ${ui_confirm.approved} == True
  foreach: null
  while: null
  body: null
  call: null
  policy: null
  hitl: null
- id: ai_match
  block: ai.invoice_payment_match
  type: null
  max_workers: null
  priority: null
  in:
    evidence_data: ${parse_zip.evidence_data}
    instruction: 請求書・入金明細を照合し、Excelに書き出す
  out:
    results: match_results
    summary: match_summary
  when:
    expr: ${ui_confirm.approved} == True
  foreach: null
  while: null
  body: null
  call: null
  policy: null
  hitl: null
- id: write_excel
  block: excel.write_results
  type: null
  max_workers: null
  priority: null
  in:
    workbook: ${upload_excel.workbook}
    data: ${ai_match.match_results}
    output_config: ${vars.output_config}
  out:
    write_summary: write_summary
  when: null
  foreach: null
  while: null
  body: null
  call: null
  policy: null
  hitl: null

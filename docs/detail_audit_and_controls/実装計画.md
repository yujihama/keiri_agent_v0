# Detail Audit & Controls 実装計画（フェーズ別）

本計画は、機能面の実装とレビューをフェーズ単位で推進するための実行指針です。各フェーズは2〜3週間スプリントを想定し、完了基準（DoD: Definition of Done）を明確に定義します。

## フェーズ構成（概観）
- P1: Control Blocks 基本3種の仕様整備と最小統合
- P2: Evidence Vault 拡張（retrieve/search/audit_report のSpec雛形→実装）
- P3: Policy-as-Code 最小実装（`control.policy_enforce`→`policy.validate` 段階移行の入口）
- P4: Reviewer Workspace v1（`ui/*` ベースの機能統合）
- P5: Control Blocks 拡張（reconciliation/validation）

---

## P1: Control Blocks 基本3種（approval / sod_check / sampling）
- 対応ドキュメント: `Control Blocks 詳細設計.md`
- 対応コード/Spec: `block_specs/processing/control.*.yaml`, `core/blocks/processing/control/*.py`

### 実装タスク
- Specの入出力スキーマを現行と同期し、サンプルPlan断片を整備
- `control.approval` のI/O記述を最新クラスに整合（Approved/violations/route_log）
- `control.sod_check` のrole_analysis/violationsスキーマの簡素化（冗長項目の注記化）
- `control.sampling` のmethodと統計指標の最小セット定義

### 完了基準（DoD）
- READMEのトレーサビリティ表が最新（P1は「実装済（基本）」）
- 各ブロックのSpec例が最新のID・entrypoint・主要I/Oに整合
- Plan最小例で3ブロックの呼び出し例が記載（YAML断片）
- 機能設計の文言から非機能/テスト/ROIの記載が排除（注記済）

---

## P2: Evidence Vault 拡張
- 対応ドキュメント: `Evidence Vault 詳細設計.md`
- 対応コード/Spec: `block_specs/processing/evidence.vault.store.yaml`（既存）、新規 `evidence.retrieve/search/audit_report` のSpec雛形

### 実装タスク
- `evidence.retrieve` Spec雛形作成（inputs: evidence_id, verify_integrity / outputs: evidence_data, metadata）
- `evidence.search` Spec雛形作成（inputs: search_criteria / outputs: search_results, total_count）
- `evidence.audit_report` Spec雛形作成（inputs: report_scope / outputs: audit_report, report_file_path）
- 「（計画）」の明示と、将来の実装ディレクトリ方針の注記

### 完了基準（DoD）
- READMEの表に Evidence 拡張（P2）が追記済み
- 3つのSpec雛形が本文に掲載（ID・entrypoint 予約名・主要I/O）
- Plan最小例で `evidence.vault.store`＋`evidence.search` 連携の断片が掲載
- 期待効果等の非機能的記載は省略注記に統一

---

## P3: Policy-as-Code 最小実装
- 対応ドキュメント: `Policy-as-Code 詳細設計.md`
- 対応コード/Spec: 現行 `control.policy_enforce`、新規 `policy.validate`（計画）

### 実装タスク
- メタ情報に段階移行を追記（現行→将来）、H2対応の明確化
- `policy.validate` の最小Spec雛形（validation_context, violations, passed）
- Plan利用例（`control.policy_enforce` の現行例＋ `policy.validate` の将来例）

### 完了基準（DoD）
- READMEの表に Policy P3が追記済み
- `Policy-as-Code` 文書に `policy.validate` 雛形と将来配置が明記
- 現行の利用例（`control.policy_enforce`）が簡潔に示されている

---

## P4: Reviewer Workspace v1
- 対応ドキュメント: `Reviewer Workspace 詳細設計.md`
- 対応コード/Spec: `ui/*`（既存タブ基盤）

### 実装タスク
- UIパスの統一（`ui/*` 構成に準拠）注記の明示
- 証跡検索・表示フローの最小導線（2クリックで証跡到達）を設計レベルで明記
- 設計例コード断片は現行パスに整合する注記を付与

### 完了基準（DoD）
- READMEの表に Reviewer（P4）が追記済み
- ワークスペース画面のタブ構成・主要導線（証跡→詳細）が明文化
- 非機能/UX/期待効果は省略注記へ統一

---

## P5: Control Blocks 拡張（reconciliation/validation）
- 対応ドキュメント: `Control Blocks 詳細設計.md`

### 実装タスク
- `control.reconciliation` のSpec雛形（inputs: left/right/keys, outputs: matched, diffs）
- `control.validation` のSpec雛形（inputs: dataset, rules, outputs: violations, summary）
- Plan利用例の最小断片を提示

### 完了基準（DoD）
- READMEの表で拡張ブロックが「計画（P5）」として明記
- 2ブロックのSpec雛形（ID・entrypoint予約名・主要I/O）が本文に掲載
- Plan断片のサンプルが存在

---

## レビュー体制（各フェーズ共通）
- ドキュメントレビュー: 設計の機能整合、命名・ID・entrypoint、Plan断片の整合性
- 実装レビュー（任意）: Spec雛形と現行実装の乖離がないかを軽く確認
- 変更履歴管理: 各フェーズ完了時にREADMEの表と当該ドキュメントのメタ情報更新

## マイルストーン
- M1（P1完了）: 基本3ブロックの機能設計が最新化、Plan断片あり
- M2（P2完了）: Evidence拡張のSpec雛形が揃い、Planから参照可能
- M3（P3完了）: Policy最小実装の移行方針と雛形が整備
- M4（P4完了）: Reviewer導線の機能設計が確定
- M5（P5完了）: 拡張ブロックの雛形が揃い、設計完了
